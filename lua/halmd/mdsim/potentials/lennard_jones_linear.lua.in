--
-- Copyright © 2010-2012 Felix Höfling
-- Copyright © 2010-2012 Peter Colberg
--
-- This file is part of HALMD.
--
-- HALMD is free software: you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation, either version 3 of the License, or
-- (at your option) any later version.
--
-- This program is distributed in the hope that it will be useful,
-- but WITHOUT ANY WARRANTY; without even the implied warranty of
-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-- GNU General Public License for more details.
--
-- You should have received a copy of the GNU General Public License
-- along with this program.  If not, see <http://www.gnu.org/licenses/>.
--

local device            = require("halmd.utility.device")
local log               = require("halmd.io.log")
local utility           = require("halmd.utility")
local module            = require("halmd.utility.module")
local numeric           = require("halmd.utility.numeric")

---
-- Linearly truncated Lennard-Jones potential
-- ==========================================
--
-- This module implements the Lennard-Jones potential with a linear truncation
-- scheme (which is equivalent to a shifted force),
--
-- .. math::
--
--    U_\text{LJ}\left(r_{ij}\right) = 4\epsilon_{ij} \left(
--        \left(\frac{\sigma_{ij}}{r_{ij}}\right)^{12}
--      - \left(\frac{\sigma_{ij}}{r_{ij}}\right)^6
--      + (r_{ij} - r_c)\cdot F_c
--    \right)
--
-- for the interaction between two particles of species :math:`i` and
-- :math:`j`.  Here, :math:`r_c` denotes the cutoff distance and :math:`F_c = -
-- U_\text{LJ}(r_c)` the force at the cutoff for the untruncated potential.
--
-- This linear truncation scheme modifies the potential drastically and at all
-- distances by adding a constant force, and we do not recommend it for future
-- work. It is mainly provided for historical reasons to connect to existing
-- data and publications. Please refer to the :class:`local r⁴ truncation
-- <halmd.mdsim.forces.trunc.local_r4>` scheme for an alternative.
--
-- References
-- ----------
--
-- #. *S. K. Das, J. Horbach, K. Binder, M. E. Fisher, and J. V. Sengers*, `J. Chem. Phys. 125, 024506 <http://dx.doi.org/10.1063/1.2215613>`_ (2006)
-- #. *S. Toxvaerd and J. C. Dyre*, `J. Chem. Phys. 134, 081102 <http://jcp.aip.org/resource/1/jcpsa6/v134/i8/p081102_s1>`_ (2011)
-- #. *S. Toxvaerd, O. J. Heilmann, and J. C. Dyre*, `J. Chem. Phys. 136, 224106 <http://jcp.aip.org/resource/1/jcpsa6/v136/i22/p224106_s1>`_ (2012)
--

-- grab C++ wrappers
local lennard_jones_linear = {
    host = assert(libhalmd.mdsim.host.potentials.lennard_jones_linear)
}
if device.gpu then
    lennard_jones_linear.gpu = assert(libhalmd.mdsim.gpu.potentials.lennard_jones_linear)
end

---
-- Construct linearly truncated Lennard-Jones potential.
--
-- :param table args: keyword arguments
-- :param args.particle: instance, or sequence of two instances, of :class:`halmd.mdsim.particle`
-- :param table args.epsilon: matrix with elements :math:`\epsilon_{ij}` (defaults to ``1``)
-- :param table args.sigma: matrix with elements :math:`\sigma_{ij}` (defaults to ``1``)
-- :param table args.cutoff: matrix with elements :math:`r_{\text{c}, ij}`
--
-- If all elements of a matrix are equal, a scalar value should be passed instead.
--
-- .. note::
--
--    The cutoff is only relevant with :class:`halmd.mdsim.forces.pair_trunc`.
--
-- .. attribute:: epsilon
--
--    Matrix with elements :math:`\epsilon_{ij}`.
--
-- .. attribute:: sigma
--
--    Matrix with elements :math:`\sigma_{ij}`.
--
-- .. attribute:: r_cut
--
--    Matrix with elements :math:`r_{\text{c}, ij}` in reduced units.
--
-- .. attribute:: r_cut_sigma
--
--    Matrix with elements :math:`r_{\text{c}, ij}` in units of :math:`\sigma_{ij}`.
--
-- .. attribute:: description
--
--    Name of potential for profiler.
--
local M = module(function(args)
    local epsilon = args and args.epsilon or 1
    if type(epsilon) ~= "table" and type(epsilon) ~= "number" then
        error("bad argument 'epsilon'", 2)
    end
    local sigma = args and args.sigma or 1
    if type(sigma) ~= "table" and type(sigma) ~= "number" then
        error("bad argument 'sigma'", 2)
    end
    local cutoff = utility.assert_kwarg(args, "cutoff")
    if type(cutoff) ~= "table" and type(cutoff) ~= "number" then
        error("bad argument 'cutoff'", 2)
    end
    local particle = utility.assert_kwarg(args, "particle")
    if type(particle) ~= "table" then
        particle = {particle, particle}
    end
    if #particle ~= 2 then
        error("bad argument 'particle'", 2)
    end

    if particle[1].memory ~= particle[2].memory then
        error("'memory' of particle instances do not match", 2)
    end
    local memory = particle[1].memory

    local nspecies = {}
    local label = {}
    for i = 1, #particle do
        table.insert(nspecies, assert(particle[i].nspecies))
        table.insert(label, assert(particle[i].label))
    end
    local label = ("lennard_jones_linear (%s ↔ %s)"):format(label[1], label[2])
    local logger = log.logger({label = label})

    -- construct instance
    if type(cutoff) == "number" then
        cutoff = numeric.scalar_matrix(nspecies[1], nspecies[2], cutoff)
    end
    if type(epsilon) == "number" then
        epsilon = numeric.scalar_matrix(nspecies[1], nspecies[2], epsilon)
    end
    if type(sigma) == "number" then
        sigma = numeric.scalar_matrix(nspecies[1], nspecies[2], sigma)
    end
    local self = lennard_jones_linear[memory](nspecies[1], nspecies[2], cutoff, epsilon, sigma, logger)

    -- add description for profiler
    self.description = property(function()
        return "linearly truncated Lennard-Jones potential"
    end)

    -- add logger instance for pair_trunc
    self.logger = property(function()
        return logger
    end)

    return self
end)

return M
