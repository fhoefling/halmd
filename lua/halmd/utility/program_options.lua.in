--
-- Copyright Â© 2012  Peter Colberg
--
-- This file is part of HALMD.
--
-- HALMD is free software: you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation, either version 3 of the License, or
-- (at your option) any later version.
--
-- This program is distributed in the hope that it will be useful,
-- but WITHOUT ANY WARRANTY; without even the implied warranty of
-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-- GNU General Public License for more details.
--
-- You should have received a copy of the GNU General Public License
-- along with this program.  If not, see <http://www.gnu.org/licenses/>.
--

local po = assert(libhalmd.program_options)

---
-- Program options
-- ===============
--
-- This module allows the use of command-line options in HALMD scripts.
--
local M = {}

local argument_parser = {}

---
-- Create new command-line parser.
--
-- Example::
--
--    local options = require("halmd.utility.program_options")
--
--    local parser = options.argument_parser()
--
function M.argument_parser()
    local desc = po.options_description()
    local option = po.option_description("help,h", po.untyped_value(), "display this help and exit")
    desc:add(option)
    return setmetatable({desc = desc, options = {}, args = {}}, {__index = argument_parser})
end

---
-- Add argument to parser.
--
-- :param string name: long name, and (optionally) short name separated by comma
-- :param table args: keyword arguments
-- :param string args.type: value type of option
-- :param string args.help: description of option for --help
-- :param boolean args.composing: allow multiple occurences with single value (default: ``false``)
-- :param boolean args.multitoken: allow multiple occurences with multiple values (default: ``false``)
-- :param function args.notifier: notifier function (optional)
-- :param args.default: default option value (optional)
-- :param args.implicit: implicit option value (optional)
--
-- The following value types are supported:
--
-- ====================   =======================================
-- Type                   Description
-- ====================   =======================================
-- boolean                Boolean
-- string                 String
-- int32                  Signed 32-bit integer
-- int64                  Signed 64-bit integer
-- uint32                 Unsigned 32-bit integer
-- uint64                 Unsigned 64-bit integer
-- float32                Single-precision floating-point
-- float64                Double-precision floating-point
-- ====================   =======================================
--
-- The optional notifier function has the following arguments:
--
-- :param table args: parsed arguments
-- :param string name: long name of this option
-- :param key: parsed value of this option
--
-- Example::
--
--    parser:add_argument("disable-gpu", {type = "boolean", help = "disable GPU acceleration"})
--
function argument_parser:add_argument(name, args)
    local name = assert(name)
    local help = assert(args.help)
    local value
    if args.multitoken or args.composing then
        value = assert(po.multivalue[args.type])()
    else
        value = assert(po.value[args.type])()
    end
    local option = po.option_description(name, value, help)
    local long_name = assert(option.long_name)
    local key = long_name:gsub("%-", "_")
    self.options[key] = option
    self.desc:add(option)

    local notifier = args.notifier
    value:notifier(function(value)
        if self.args[key] == nil then
            self.args[key] = value
        elseif notifier then
            notifier(self.args, key, value)
        end
    end)

    if args.multitoken then
        value:multitoken()
    elseif args.composing then
        value:composing()
    end
    if args.default then
        value:default_value(args.default)
    end
    if args.implicit then
        value:implicit_value(args.implicit)
    end
end

---
-- Set default option values.
--
-- :param table defaults: argument names with default values
--
-- Example::
--
--     parser:set_defaults({particles = {9000, 1000}, number_density = 0.8})
--
function argument_parser:set_defaults(defaults)
    local options = assert(self.options)
    for k, v in pairs(defaults) do
        local option = options[k]
        if not option then
            error(("undefined argument '%s'"):format(k), 2)
        end
        local semantic = assert(option.semantic)
        semantic:default_value(v)
    end
end

---
-- Parse arguments.
--
-- :param table args: string array with command-line arguments, or ``nil``
-- :returns: parsed arguments
--
-- Example::
--
--    local args = parser:parse_args()
--
function argument_parser:parse_args(args)
    local args = args or arg
    local parser = po.command_line_parser(args)
    parser:options(self.desc)
    parser:disallow_guessing()
    parser:positional(po.positional_options_description())
    local parsed = parser:run()
    local vm = po.variables_map()
    vm:store(parsed)
    if vm:count("help") > 0 then
        print(self.desc)
        os.exit(0)
    end
    vm:notify()
    vm:notify()
    return self.args
end

return M
